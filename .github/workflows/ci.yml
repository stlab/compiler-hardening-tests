name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Linux builds with GCC and Clang
  linux:
    name: ${{ matrix.compiler }} - ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - compiler: gcc-14
            cxx: g++-14
            preset: gcc-x64
            arch: x86_64
          - compiler: clang-18
            cxx: clang++-18
            preset: clang-x64
            arch: x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure CMake
        run: |
          cmake --preset=${{ matrix.preset }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}

      - name: Build
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Run
        run: ./build/${{ matrix.preset }}/hardening-test

  # macOS builds with Apple Clang
  macos:
    name: Apple Clang - ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-latest
            preset: apple-clang-x64
          - arch: arm64
            runner: macos-latest
            preset: apple-clang-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure CMake
        run: cmake --preset=${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Run
        run: ./build/${{ matrix.preset }}/hardening-test

  # Windows builds with MSVC
  windows:
    name: MSVC - ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, ARM64]
        include:
          - arch: x64
            preset: msvc-x64
          - arch: ARM64
            preset: msvc-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # - name: Setup MSVC
      #   uses: ilammy/msvc-dev-cmd@v1
      #   with:
      #     arch: ${{ matrix.arch }}

      - name: Configure CMake
        run: cmake --preset=${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Run
        if: matrix.arch == 'x64'
        run: .\build\${{ matrix.preset }}\Debug\hardening-test.exe

  # WebAssembly build with Emscripten
  emscripten:
    name: Emscripten - WebAssembly
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          # Make sure to set a version number!
          version: 1.38.40
          # This is the name of the cache folder.
          # The cache folder will be placed in the build directory,
          #  so make sure it doesn't conflict with anything!
          actions-cache-folder: "emsdk-cache"

      - name: Verify
        run: emcc -v

      - name: Configure CMake
        run: cmake --preset=emscripten-wasm

      - name: Build
        run: cmake --build --preset=emscripten-wasm

      - name: Run with Node.js
        run: node ./build/emscripten-wasm/hardening-test.wasm

  # Static Analysis
  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure and Build with clang-tidy
        run: |
          cmake --preset=clang-tidy
          cmake --build --preset=clang-tidy
