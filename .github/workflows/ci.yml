name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Linux builds with GCC and Clang
  linux:
    name: ${{ matrix.compiler }} - ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # x86-64 builds
          - compiler: gcc-14
            cxx: g++-14
            preset: gcc-x64
            arch: x86_64
            runner: ubuntu-latest
          - compiler: clang-18
            cxx: clang++-18
            preset: clang-x64
            arch: x86_64
            runner: ubuntu-latest
          # ARM64 builds
          - compiler: gcc-14
            cxx: g++-14
            preset: gcc-arm64
            arch: arm64
            runner: ubuntu-24.04-arm
          - compiler: clang-18
            cxx: clang++-18
            preset: clang-arm64
            arch: arm64
            runner: ubuntu-24.04-arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure CMake
        run: |
          cmake --preset=${{ matrix.preset }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.cxx }}

      - name: Build
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Run
        run: ./build/${{ matrix.preset }}/hardening-test

  # macOS builds with Apple Clang
  macos:
    name: Apple Clang - ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            runner: macos-15-intel
            preset: apple-clang-x64
          - arch: arm64
            runner: macos-latest
            preset: apple-clang-arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure CMake
        run: cmake --preset=${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Run
        run: ./build/${{ matrix.preset }}/hardening-test

  # Windows builds with MSVC
  windows:
    name: MSVC - ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            preset: msvc-x64
            runner: windows-latest
          - arch: arm64
            preset: msvc-arm64
            runner: windows-11-arm

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure CMake
        run: cmake --preset=${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset=${{ matrix.preset }}

      - name: Run
        run: .\build\${{ matrix.preset }}\hardening-test.exe

  # WebAssembly build with Emscripten
  emscripten:
    name: Emscripten - WebAssembly
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 4.0.23
          actions-cache-folder: "emsdk-cache"

      - name: Verify
        run: emcc -v

      - name: Configure CMake
        run: cmake --preset=emscripten-wasm

      - name: Build
        run: cmake --build --preset=emscripten-wasm

      - name: List generated files
        run: ls -lh ./build/emscripten-wasm/

      - name: Run with Node.js
        run: $EMSDK_NODE ./build/emscripten-wasm/hardening-test.js

  # Static Analysis
  static-analysis:
    name: Static Analysis (clang-tidy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Configure and Build with clang-tidy
        run: |
          cmake --preset=clang-tidy
          cmake --build --preset=clang-tidy
